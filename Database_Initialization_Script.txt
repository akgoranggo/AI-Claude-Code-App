-- Database initialization script
-- This script runs when the PostgreSQL container starts for the first time

-- Create the ULID generation function
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- ULID generation function
CREATE OR REPLACE FUNCTION generate_ulid()
RETURNS varchar AS $$
DECLARE
    timestamp_part varchar(10);
    random_part varchar(16);
    unix_time bigint;
    crockford_chars varchar(32) := '0123456789ABCDEFGHJKMNPQRSTVWXYZ';
BEGIN
    -- Get current Unix timestamp in milliseconds
    unix_time := (EXTRACT(EPOCH FROM clock_timestamp()) * 1000)::bigint;

    -- Encode timestamp (first 10 characters)
    timestamp_part := '';
    FOR i IN REVERSE 9..0 LOOP
        timestamp_part := timestamp_part || substr(crockford_chars, ((unix_time >> (i * 5)) & 31) + 1, 1);
    END LOOP;

    -- Generate random part (last 16 characters)
    random_part := '';
    FOR i IN 1..16 LOOP
        random_part := random_part || substr(crockford_chars, (floor(random() * 32)::int) + 1, 1);
    END LOOP;

    RETURN timestamp_part || random_part;
END;
$$ LANGUAGE plpgsql VOLATILE;

-- Create the default application schema
CREATE SCHEMA IF NOT EXISTS app;

-- Grant permissions
GRANT ALL ON SCHEMA app TO postgres;
GRANT USAGE ON SCHEMA app TO postgres;

-- Set default search path
ALTER DATABASE pims_db SET search_path TO app, public;


CREATE TABLE organization (
  -- Primary key (ULID)
  id VARCHAR PRIMARY KEY DEFAULT generate_ulid(),

  -- Core business fields
  name VARCHAR(255) NOT NULL,
  legal_name VARCHAR(255),
  tax_id VARCHAR(50),
  billing_email VARCHAR(255),
  logo_url VARCHAR(500),
  timezone VARCHAR(50) NOT NULL DEFAULT 'America/New_York',

  -- Status
  is_active BOOLEAN NOT NULL DEFAULT TRUE,

  -- Audit fields
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  -- Soft delete
  deleted_at TIMESTAMP
);

CREATE TABLE "user" (
  -- Primary key (ULID)
  id VARCHAR PRIMARY KEY DEFAULT generate_ulid(),

  -- Core identity fields
  email VARCHAR(255) NOT NULL UNIQUE,
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  profile_image_url VARCHAR(500),
  role VARCHAR(50) NOT NULL DEFAULT 'user',

  -- Organization membership (Many-to-One)
  organization_id VARCHAR
    REFERENCES organization(id),

  -- Organizational hierarchy (self-reference)
  reports_to_user_id VARCHAR
    REFERENCES "user"(id),

  -- Audit fields
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE session (
  -- Session ID (primary key)
  sid VARCHAR PRIMARY KEY,

  -- Session payload (JSON string)
  sess VARCHAR(10000) NOT NULL,

  -- Expiration timestamp
  expire TIMESTAMP NOT NULL
);

CREATE TABLE audit_log (
  id VARCHAR PRIMARY KEY DEFAULT generate_ulid(),

  -- What changed
  entity_type VARCHAR(100) NOT NULL,
  entity_id VARCHAR(50) NOT NULL,
  action VARCHAR(50) NOT NULL,

  -- Who made the change
  user_id VARCHAR(50),
  user_email VARCHAR(255),

  -- Change details
  previous_data JSONB,
  new_data JSONB,
  changed_fields JSONB,

  -- Context
  request_id VARCHAR(50),
  ip_address VARCHAR(45),
  user_agent TEXT,

  -- Timestamp
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

